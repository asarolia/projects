using System;
using System.Collections.Generic;
using Data = System.Data;
using System.Diagnostics.Contracts;
using DML.Generator.Domain;
using Microsoft.Office.Interop.Excel;
using System.Globalization;

namespace DML.Generator.Domain.Extensions
{
    public static class ExtensionMethods
    {
        /// <summary>
        /// Toes the data table.
        /// </summary>
        /// <param name="Info">The info.</param>
        /// <returns></returns>
        public static Data::DataTable ToDataTable(this DMLInfo Info)
        { 
            Contract.Requires(Info != null);
            Data::DataTable table = new Data::DataTable(Info.SheetData.TableName);
            BuildDataColumns(ref table,Info);
            return table;
        }

        /// <summary>
        /// Builds the data columns.
        /// </summary>
        /// <param name="table">The table.</param>
        /// <param name="Info">The info.</param>
        private static void BuildDataColumns(ref Data::DataTable table, DMLInfo Info)
        {
            List<Data::DataColumn> keyColumn = new List<Data::DataColumn>();
            
            Data::DataColumn actionColumn = new Data::DataColumn
                {
                    ColumnName = "Action",
                    DataType = typeof(System.String)
                };
            table.Columns.Add(actionColumn);

            for (int i = 2; i <= Info.SheetData.ColumnCount; i++)
            {
                Data::DataColumn column = new Data::DataColumn
                {
                    ColumnName = Info.SheetData.UsedRange[Info.SheetData.ColumnRowIndex, i].ToString(),
                    DataType = GetDataType(Info.SheetData.UsedRange[Info.SheetData.TypeRowIndex, i].ToString())
                };

                SetProperties(Info.SheetData.UsedRange[Info.SheetData.TypeRowIndex, i].ToString(), ref column);

                if (Info.SheetData.UsedRange[Info.SheetData.PrimaryRowIndex, i] != null && string.Equals(Info.SheetData.UsedRange[Info.SheetData.PrimaryRowIndex, i].ToString().ToLower(), "yes"))
                {
                    keyColumn.Add(column);
                }
                table.Columns.Add(column);
            }
            table.PrimaryKey = keyColumn.ToArray();
            PopulateDataTable(ref table, Info);
        }

        /// <summary>
        /// Populates the data table.
        /// </summary>
        /// <param name="table">The table.</param>
        /// <param name="Info">The info.</param>
        private static void PopulateDataTable(ref Data::DataTable table, DMLInfo Info)
        {
            for (int rowCount = Info.SheetData.StartRowIndex + 1; rowCount < Info.SheetData.EndRowIndex; rowCount++)
            {
                Data::DataRow dataRow = table.NewRow();

                for (int colCount = 1; colCount <= Info.SheetData.ColumnCount; colCount++)
                {
                    if (dataRow.Table.Columns[colCount - 1].DataType == typeof(System.String) || !string.IsNullOrEmpty(Info.SheetData.UsedRange[rowCount, colCount].ToString()))
                    {
                        dataRow[colCount - 1] = Info.SheetData.UsedRange[rowCount, colCount];
                    }
                }
                table.Rows.Add(dataRow);
            }
        }

        /// <summary>
        /// Sets the properties.
        /// </summary>
        /// <param name="colType">Type of the col.</param>
        /// <param name="column">The column.</param>
        /// <remarks></remarks>
        private static void SetProperties(string colType, ref Data.DataColumn column)
        {
            if (column.DataType == typeof(System.String))
            { 
                if (colType.ToUpper().IndexOf('(') > -1)
                {
                    column.MaxLength = Int32.Parse(colType.Split('(')[1].Replace(")", string.Empty).Trim());
                }
            }
        }

        /// <summary>
        /// Splits the length of the by.
        /// </summary>
        /// <param name="str">The STR.</param>
        /// <param name="maxLength">Length of the max.</param>
        /// <returns></returns>
        public static IEnumerable<string> SplitByLength(this string str, int maxLength)
        {
            for (int index = 0; index < str.Length; index += maxLength)
            {
                yield return str.Substring(index, Math.Min(maxLength, str.Length - index));
            }
        }

        /// <summary>
        /// Gets the type of the data.
        /// </summary>
        /// <param name="ColType">Type of the col.</param>
        /// <returns></returns>
        private static Type GetDataType(string colType)
        {
            if (colType.ToUpper().IndexOf("CHAR") > -1)
            {
                return System.Type.GetType("System.String");
            }
            
            if (colType.ToUpper().IndexOf("INT") > -1)
            {
                return System.Type.GetType("System.Int32");
            }
                       
            if (colType.ToUpper().IndexOf("DATE") > -1 || colType.ToUpper().IndexOf("TIME") > -1)
            {
                return System.Type.GetType("System.DateTime");
            }
            
            if (colType.ToUpper().IndexOf("DECIMAL") > -1)
            {       
                return System.Type.GetType("System.Decimal");
            }

            throw new ArgumentException (string.Format("Data type is not supported for {0}", colType));
        }
    }
}